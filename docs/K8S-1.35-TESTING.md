# Kubernetes 1.35 Module Compatibility Testing Guide

This document provides comprehensive testing procedures for validating Kubernetes 1.35.x compatibility with SIGHUP Distribution modules.

## Test Categories

### 1. Preflight Validation Tests

Preflight checks automatically validate Kubernetes 1.35 specific requirements during cluster creation/upgrade.

#### OnPremises Cluster Tests

**Local Environment Checks:**
- cgroup v2 support validation
- containerd 2.0+ version check
- Node OS compatibility verification (Ubuntu 22.04+, RHEL 9+, Debian 12+)

**Test execution:**
```bash
# Create OnPremises cluster with K8s 1.35
furyctl create --config test/e2e/testdata/k8s-1.35.0-onpremises.yaml

# Expected: All preflight checks pass
# Logs should show:
# - "Checking cgroup v2 support..."
# - "Checking containerd version..."
# - "Checking kube-proxy mode..."
# - "Checking node OS compatibility..."
```

#### EKS Cluster Tests

**Cluster-level Checks:**
- kube-proxy IPVS mode detection
- Node OS compatibility (including Amazon Linux 2)

**Test execution:**
```bash
# Create EKS cluster with K8s 1.35
furyctl create --config test/e2e/testdata/k8s-1.35.0-eks.yaml

# Expected: Cluster creation succeeds
# Warnings logged (non-blocking) for detected issues
# Logs should show:
# - "Checking kube-proxy mode..."
# - "Checking node OS compatibility..."
```

#### KFDDistribution Tests

**Distribution Deployment Checks:**
- Module version compatibility validation
- kube-proxy IPVS deprecation warnings

**Test execution:**
```bash
# Deploy KFD on existing K8s 1.35 cluster
furyctl apply --config test/e2e/testdata/k8s-1.35.0-kfddistribution.yaml

# Expected: Distribution deploys successfully
# Module compatibility warnings logged if needed
```

### 2. Module Breaking Changes Tests

Module compatibility is validated against known breaking changes for Kubernetes 1.35.

#### Tested Modules and Minimum Versions

| Module | Min Version | Breaking Change |
|--------|------------|-----------------|
| auth | v0.6.0 | WebSocket RBAC validation |
| logging | v5.2.0 | New audit log formats |
| networking | v3.0.0 | CNI compatibility improvements |
| monitoring | v4.0.1 | Metric changes for K8s 1.35 |

#### Test execution:

```bash
# Run unit tests for breaking changes detection
go test -v ./internal/distribution -run TestBreakingChangeValidator

# Test a configuration with incompatible modules
furyctl create --config test-invalid-modules.yaml
# Expected: Fails with clear error messages about incompatible versions
```

### 3. Version Range Compatibility Tests

Test configurations across all supported Kubernetes 1.35.x patch versions.

**Tested versions:** v1.35.0, v1.35.1, v1.35.2, v1.35.3, v1.35.4, v1.35.5

**Test matrices:**

#### OnPremises
- k8s-1.35.0-onpremises.yaml
- k8s-1.35.3-onpremises.yaml

#### EKS
- k8s-1.35.0-eks.yaml
- k8s-1.35.5-eks.yaml

#### KFDDistribution
- k8s-1.35.0-kfddistribution.yaml

### 4. Staging Environment Testing

#### Prerequisites

```bash
# Clone and prepare test environment
git clone https://github.com/sighupio/furyctl.git
cd furyctl

# Build furyctl with latest changes
make build

# Prepare test infrastructure
./scripts/prepare-test-env.sh
```

#### Test Scenarios

**Scenario 1: Fresh OnPremises Cluster Deployment**
```bash
# 1. Prepare test machines (at least 3: 1 master, 2 workers)
export TEST_HOSTS="10.0.0.10,10.0.0.11,10.0.0.12"

# 2. Configure cluster spec
cat > test-cluster.yaml <<EOF
apiVersion: kfd.sighup.io/v1alpha2
kind: OnPremises
metadata:
  name: test-k8s-1.35
spec:
  distributionVersion: v1.35.0
  hosts:
    - name: master
      ip: 10.0.0.10
      roles: [master, worker]
      ssh:
        user: root
        keyPath: /root/.ssh/id_rsa
EOF

# 3. Run deployment
furyctl create --config test-cluster.yaml

# 4. Verify deployment
kubectl get nodes
kubectl get pods -A

# 5. Run validation tests
./scripts/validate-k8s-1.35.sh
```

**Scenario 2: EKS Cluster Upgrade to 1.35**
```bash
# 1. Create EKS cluster with K8s 1.34
furyctl create --config k8s-1.34-eks.yaml

# 2. Update configuration to K8s 1.35
sed -i 's/distributionVersion: v1.34.0/distributionVersion: v1.35.0/' k8s-1.34-eks.yaml

# 3. Run upgrade (preflight validates compatibility)
furyctl update --config k8s-1.34-eks.yaml

# 4. Verify upgrade
aws eks describe-cluster --name <cluster-name>
```

**Scenario 3: KFDDistribution Module Validation**
```bash
# 1. Create distribution config with correct modules
cat > distribution.yaml <<EOF
apiVersion: kfd.sighup.io/v1alpha2
kind: KFDDistribution
spec:
  distributionVersion: v1.35.0
  modules:
    auth: v0.6.0
    logging: v5.2.0
    networking: v3.0.0
    monitoring: v4.0.1
    ingress: v4.1.1
    dr: v3.2.0
    opa: v1.15.0
    tracing: v1.3.0
EOF

# 2. Deploy (should succeed)
furyctl apply --config distribution.yaml

# 3. Verify all modules deployed
kubectl get ns
kubectl get pods -A | grep -E "auth|logging|monitoring|networking|ingress|dr|opa|tracing"

# 4. Test with incompatible module version
sed -i 's/auth: v0.6.0/auth: v0.5.0/' distribution.yaml

# 5. Attempt deployment (should fail with clear message)
furyctl apply --config distribution.yaml
```

## Test Validation Checklist

### Preflight Checks
- [ ] cgroup v2 detection works correctly
- [ ] containerd version check identifies 1.x installations
- [ ] kube-proxy IPVS mode warnings appear
- [ ] Node OS compatibility validation works
- [ ] WebSocket RBAC changes are detected

### Module Compatibility
- [ ] Module version requirements are enforced
- [ ] Clear error messages for incompatible versions
- [ ] Breaking changes documentation is accurate
- [ ] All modules specified in patch files are validated

### Cluster Deployment
- [ ] OnPremises clusters deploy successfully
- [ ] EKS clusters deploy successfully
- [ ] KFDDistribution deploys successfully
- [ ] Version range (1.35.0-1.35.5) is fully supported

### Warning/Error Messages
- [ ] Preflight warnings are informative
- [ ] Error messages suggest fixes
- [ ] Logs show clear progression through checks

## Known Issues and Workarounds

### Issue 1: cgroup v1 Detected
**Error:** `cgroup v1 detected but Kubernetes 1.35 requires cgroup v2`

**Resolution:** Upgrade to a newer OS version:
- Ubuntu 22.04+ (LTS recommended)
- RHEL/CentOS 9+
- Debian 12+

### Issue 2: containerd 1.x Detected
**Error:** `containerd 1.x is EOL and not supported in Kubernetes 1.35`

**Resolution:** Upgrade containerd to 2.0+
```bash
apt-get install containerd=2.0.0 # or newer
# OR
yum install containerd-2.0.0 # or newer
```

### Issue 3: IPVS Mode Detected
**Warning:** `IPVS is deprecated in Kubernetes 1.35`

**Resolution:** Migrate to nftables:
```bash
# Update kube-proxy configuration
kubectl patch ds -n kube-system kube-proxy \
  --type='json' -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/command", "value": [...]}]'
```

## Metrics and Success Criteria

- **Deployment Success Rate:** >99% for compatible configurations
- **Preflight Check Accuracy:** 100% detection of incompatibilities
- **Module Validation Time:** <5 seconds per configuration
- **User Experience:** Clear error messages for all failure cases

## Continuous Testing

The following tests run automatically on each commit:

1. Unit tests: `go test ./internal/distribution -run TestBreakingChange`
2. Integration tests on test configurations
3. Version range validation tests
4. Breaking changes detection tests

## Reporting Issues

If you encounter issues during testing:

1. Collect logs: `furyctl logs --all > k8s-1.35-test.log`
2. Include test configuration (sanitized)
3. Include error output and environment details
4. Report at: https://github.com/sighupio/furyctl/issues

## Additional Resources

- [Kubernetes 1.35 Release Notes](https://kubernetes.io/blog/2024/01/kubernetes-1-35-release/)
- [SIGHUP Distribution Documentation](https://docs.fury.sighup.io)
- [Furyctl Configuration Guide](./CONFIG-GUIDE.md)
